ALTER SESSION SET CONTAINER = FREEPDB1;

ALTER SESSION SET CURRENT_SCHEMA = ELECTRON_USER;


CREATE TABLE USERS
(
    USER_ID  VARCHAR2(32) DEFAULT SYS_GUID() PRIMARY KEY,
    EMAIL    NVARCHAR2(50) NOT NULL UNIQUE,
    USERNAME NVARCHAR2(50) NOT NULL UNIQUE
);
-- Nie musze tu dodawac indeksow bo indexy sa automatyczne dla UNIQUE kolumn

CREATE TABLE USER_CREDENTIALS
(
    USER_ID                    VARCHAR2(32) PRIMARY KEY,
    PASSWORD                   VARCHAR2(128) NOT NULL,
    CONSTRAINT FK_USER_CREDENTIALS_USERS FOREIGN KEY (USER_ID) REFERENCES USERS (USER_ID)
        ON DELETE CASCADE,
    USER_PUBLIC_KEY            BLOB          NOT NULL,
    USER_ENCRYPTED_PRIVATE_KEY BLOB          NOT NULL,
    KEY_ENCRYPTION_SALT        BLOB          NOT NULL,
    KEY_ENCRYPTION_IV          BLOB          NOT NULL
);

CREATE TABLE MESSAGES
(
    MESSAGE_ID        NUMBER(19) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    SENDER_ID         VARCHAR2(32) NOT NULL,
    CONSTRAINT FK_SENDER_USER FOREIGN KEY (SENDER_ID) REFERENCES USERS (USER_ID),
    SENT_DATE         TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    ENCRYPTED_MESSAGE BLOB         NOT NULL,
    IV                BLOB         NOT NULL
);
CREATE INDEX SENDER_MESSAGES ON MESSAGES (SENDER_ID);

CREATE TABLE MESSAGE_RECEIVERS
(
    MESSAGE_ID               NUMBER(19),
    CONSTRAINT FK_MESSAGE FOREIGN KEY (MESSAGE_ID) REFERENCES MESSAGES (MESSAGE_ID),
    RECEIVER_ID              VARCHAR2(32),
    CONSTRAINT FK_RECEIVER FOREIGN KEY (RECEIVER_ID) REFERENCES USERS (USER_ID),
    IS_SENDER BOOLEAN NOT NULL,
    IS_RECEIVER BOOLEAN NOT NULL,
    MESSAGE_READ             BOOLEAN DEFAULT FALSE NOT NULL,
    ENCRYPTED_ENCRYPTION_KEY BLOB                  NOT NULL,
    CONSTRAINT PK_MESSAGE_RECEIVERS PRIMARY KEY (MESSAGE_ID, RECEIVER_ID)
);

CREATE TABLE ATTACHMENTS
(
    ATTACHMENT_ID NUMBER(19) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MESSAGE_ID    NUMBER(19) NOT NULL,
    CONSTRAINT FK_ATTACHMENT_MESSAGES FOREIGN KEY (MESSAGE_ID) REFERENCES MESSAGES (MESSAGE_ID)
        ON DELETE CASCADE,
    ENCODED_DATA  BLOB       NOT NULL
);
--     CONSTRAINT CHECK_FILE_SIZE CHECK (FILE_SIZE <= 5000000)