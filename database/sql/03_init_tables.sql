ALTER SESSION SET CONTAINER = FREEPDB1;

ALTER SESSION SET CURRENT_SCHEMA = ELECTRON_USER;


CREATE TABLE USERS
(
    USER_ID  VARCHAR2(32) DEFAULT SYS_GUID() PRIMARY KEY,
    EMAIL    NVARCHAR2(50) NOT NULL UNIQUE,
    USERNAME NVARCHAR2(50) NOT NULL UNIQUE
);
CREATE INDEX USER_EMAIL_INDEX ON USERS (EMAIL);

CREATE TABLE USER_CREDENTIALS
(
    USER_ID  VARCHAR2(32) PRIMARY KEY,
    PASSWORD VARCHAR2(128) NOT NULL,
    CONSTRAINT FK_USER_CREDENTIALS_USERS FOREIGN KEY (USER_ID) REFERENCES USERS (USER_ID)
        ON DELETE CASCADE
);

CREATE TABLE MESSAGES
(
    MESSAGE_ID NUMBER(19) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    SENDER_ID VARCHAR2(32) NOT NULL,
    CONSTRAINT FK_SENDER_USER FOREIGN KEY (SENDER_ID) REFERENCES USERS (USER_ID),
    RECEIVER_ID VARCHAR2(32) NOT NULL,
    CONSTRAINT FK_RECEIVER_USER FOREIGN KEY (RECEIVER_ID) REFERENCES USERS (USER_ID),
    MESSAGE_SUBJECT NVARCHAR2(100) NOT NULL,
    MESSAGE_TEXT NVARCHAR2(2048),
    DELETED_BY_SENDER BOOLEAN DEFAULT FALSE NOT NULL,
    DELETED_BY_RECEIVER BOOLEAN DEFAULT FALSE NOT NULL
);
CREATE INDEX SENDER_MESSAGES ON MESSAGES (SENDER_ID);
CREATE INDEX RECEIVER_MESSAGES ON MESSAGES (RECEIVER_ID);

CREATE OR REPLACE TRIGGER TRIGGER_DELETE_MESSAGE_IF_DELETED_BY_SENDER_AND_RECEIVER AFTER UPDATE ON MESSAGES
    FOR EACH ROW
    BEGIN
        IF :NEW.DELETED_BY_SENDER = TRUE AND :NEW.DELETED_BY_RECEIVER = TRUE THEN
            DELETE FROM MESSAGES WHERE MESSAGE_ID = :NEW.MESSAGE_ID;
        END IF;
    END;


CREATE TABLE ATTACHMENTS
(
    ATTACHMENT_ID NUMBER(19) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MESSAGE_ID NUMBER(19) NOT NULL,
    CONSTRAINT FK_ATTACHMENT_MESSAGES FOREIGN KEY (MESSAGE_ID) REFERENCES MESSAGES (MESSAGE_ID)
    ON DELETE CASCADE,
    FILE_NAME NVARCHAR2(255) NOT NULL,
    FILE_DATA BLOB NOT NULL,
    FILE_SIZE NUMBER(7) NOT NULL,
    CONSTRAINT CHECK_FILE_SIZE CHECK (FILE_SIZE <= 5000000)

)